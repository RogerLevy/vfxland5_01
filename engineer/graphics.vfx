\ =============================================================================
\ Framerate independence
\ =============================================================================

redef : ticks  ( n - ms )
    s>f 1000e tps f/ f* f>s ;

: !delta  ( - )
    ustime  ucounter 2dup to ustime  2swap 2-
        d>s to usdelta
    usdelta s>f 1000000e f/ to sdelta
    ustime 1000 m/ to mstime
    sdelta f>p to pdelta ;

\ =============================================================================
\ Window management
\ =============================================================================

extern void * GetForegroundWindow( );
extern bool SetForegroundWindow( void * hwnd );
GetForegroundWindow value vfx-hwnd
\ vfx-hwnd 0 0 0 0 0 $41 SetWindowPos drop 

: >display ( - )
    flushOP-gen drop \ flush buffered output (VFX)
    reset-keyboard 
    display al_get_win_window_handle SetForegroundWindow drop ;

: >vfx ( - )
    vfx-hwnd SetForegroundWindow drop ;

: fullscreen ( - )
    ." FULLSCREEN" cr -1 to fullscreen? ;

: windowed ( - )
    ." WINDOWED" cr 0 to fullscreen? ;

: *display ( - )
    \ fullscreen? if fullscreen else windowed then
    create-display  going off ;

: winmode ( - )
    2 zoom ! 
    appw apph fullscreen? resize-display
    !delta !delta ;

: w/f ( - )
    \ Display mode switching for release builds
    fullscreen? if windowed else fullscreen then
    winmode ;

\ =============================================================================
\ Drawing primitives
\ =============================================================================

create pen 0 , 0 , \ int

: at ( x y - ) pen 2! ;
: at@ ( - x y ) pen 2@ ;
: at@f ( - f:x f:y ) at@ 2s>f ;
: +at ( x y - ) pen 2+! ;

: albmpw ( albmp - w ) dup if al_get_bitmap_width then ;
: albmph ( albmp - h ) dup if al_get_bitmap_height then ;

: draw-bitmap ( albmp n - )
    over if at@f al_draw_bitmap else 2drop then ;

: *subbmp ( albmp w h - albmp' )
    at@ 2swap al_create_sub_bitmap ?dup 
    0= abort" al_create_sub_bitmap error" ;

: -albmp ( albmp - )
    ?dup -exit al_destroy_bitmap ;

redef : cls ( - )
    0e 0e 0e 1e al_clear_to_color ;

include %idir%/matrix.vfx
include %idir%/print.vfx
include %idir%/../textmode/textmode.vfx

 : z ( - n )
    zoom @ ;