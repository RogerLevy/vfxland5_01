fast{

crucial test: check-object ( a - a n:res )
    dup  valid-object? ;
        
before { check-object
wrap-word {

before as check-object
wrap-word as


redef : (->property) ( property - ) ( obj - a )
    \ dynamically called by old ->
    \ optimizes down to 2 instructions when compiled with validations off
    validations @ if 
        ( property ) ?literal s" ->property" evaluate
    exit then
    2 cells + @ ?literal \ -> offset @ ?literal 
    fast{ s" over >cla @ + @ +" evaluate fast} 
; immediate

: validate-object
    dup valid-object? not 
        abort" VALIDATE-OBJECT >> Invalid object." ;

redef : -> ( object <name> - a )
    preword find not abort" -> >> Field name not found"
    >body cell+ @ MAGIC_PROPERTY = if
        validations @ if   s" validate-object" evaluate   then
        ' >body s" (->property)" evaluate 
    else
        ' >body 2 cells + @ ?literal s" +" evaluate
    then ; immediate 

:noname  ( obj protocol - obj protocol )
    safety @ -exit
    over valid-object? not
        abort" PROTOCOL-VALIDATIONS >> Invalid object." ;
is protocol-validations

fast}