\ ------------------------------------------------------------------------------
\ Engineer 1.0 internal version 2 (regressed)
\ ------------------------------------------------------------------------------

\ =============================================================================
\ %vfxland5% string macro
\ =============================================================================

also substitutions definitions
    create vfxland5 256 allot&erase
    s" %idir%\.." expand vfxland5 place
only forth definitions

\ =============================================================================
\ Core System Components
\ =============================================================================

include %idir%/checks.vfx
include %idir%/variables.vfx \ System variables
include %idir%/window.vfx

\ =============================================================================
\ Game services
\ =============================================================================

fload %idir%/../forge/lib/allegro5/graphics.vfx   \ Graphics functions
fload %idir%/../forge/lib/allegro5/input.vfx      \ Input functions
fload %idir%/border.vfx     \ TV border / scaling
fload %idir%/go.vfx         \ Main Loop

\ =============================================================================
\ Reset System Classifiers
\ =============================================================================

|| : fresh,  dup , /classifier move, ;

|| create fresh-classifiers 
    \ TODO: do this automatically
    /classifier cell+ array{
        %object fresh,    
        %iterable fresh,
        %lifo fresh,
        %fifo fresh,
        %class fresh,
        %trait fresh,
        %property fresh,
        %static fresh,
        %protocol fresh,
        %array fresh,
        %stack fresh,   
        %object-array fresh,
        %global fresh,
    array}

|| : reset-classifier ( a - )
    @+ ( src dest ) /classifier move ;

|| create fresh-all-classifiers classifiers #max-classifiers cells move,

|| : reset-system-classifiers ( - )
    ['] reset-classifier fresh-classifiers eacha 
    fresh-all-classifiers classifiers #max-classifiers cells move ;

\ =============================================================================
\ Entry Points  
\ =============================================================================

|| : init-vfx-console
    -1 line# !
    hWndMain to vfx-hwnd
    vfx-hwnd z" VFX Console" SetWindowText drop 
    consoledev op-handle ! ;

|| : vfxforth-entrypoint ( hinst hpinst lpcommand nshow -- res )
    [ ' EntryPoint >body @ compile, ] ;

borrow nib2>> init-nib

|| : empty-engineer ( - )
    reset-format-buffers
    reset-strout-buffers
    init-nib
    reset-system-classifiers
    ['] noop 'show !
    ['] noop is boot
    ['] noop is onSwitchIn
    honing off ;

redef : empty ( - )
    \ debug @ -exit
    rs
    empty-engineer
    only forth definitions
    empty ; 
    \ s" anew gildpoint" evaluate ;

\ Isolation tool - for verifying that modules in a project can be loaded
\ individually.
VARIABLE isolation
REDEF : MODULE  isolation @ if empty then require ;

: cartridge ( - )
    \ Load user program
    empty page hold off
    s" main.vfx" fileExist? if s" main.vfx" floaded then ;

also substitutions 
    aka vfxland5 vfxland5
previous

: ?..  wd@ '\' ending s" bin" s= if s" .." $cwd then ;
: init-xrefs  +xrefs  256 1024 * xref-kb ;
: init-vfxland5-path  s" %bin%\.." expand vfxland5 place ;
: init-paths  init-vfxland5-path  ;
: dev-init  empty init-xrefs init-paths ;
: init-home-path  ?.. wd@ home-path$ place ;

: frigid ( - )
    \ Initialize runtime environment
    rs
    hold off
    debug @ if dev-init then
    init-home-path
    init-mersenne
    init-allegro
    *display
    0d to ustime 
;

redef : main ( - )
    \ Release cold start sequence - initialize all systems and begin execution
    frigid boot go ;

: debug-cold ( - )
    vfxforth-entrypoint init-vfx-console ;

\ =============================================================================
\ Turnkey creation
\ =============================================================================

: save-release ( - <path> )
    ['] main is EntryPoint
    fullscreen?
        debug @ hold @
            ide off
            repl off
            debug off
            hold off
            fullscreen
            esc-quits off
            0 to GenINI?
            0 to InitSupport?
            save-exe cr
        hold ! debug !
    if fullscreen else windowed then 
    repl on
    esc-quits on ;

: save-debug ( - <path> )
    ['] debug-cold is EntryPoint
    fullscreen?
        ide @ repl @ debug @ hold @
            ide off
            repl off
            debug off \ This disables Engineer-only initialization.
                      \ Counter-intuitive because we want to debug the game not Engineer.
            hold off
            windowed
            ['] (.cold) is .cold
            -1 to GenINI?
            0 to InitSupport?
            save-exe cr
        hold ! debug ! repl ! ide !
    if fullscreen else windowed then ;

: save-dev ( - <path> )
    fullscreen?
        ide @ repl @ hold @
            \ ide on
            \ repl on
            hold off
            windowed
            save-exe cr
        hold ! repl ! ide !
    if fullscreen else windowed then ;

\ =============================================================================
\ Development tool commands
\ =============================================================================

fload %idir%/tools.vfx
fload %idir%/ls.vfx

public
include %vfxland5%/forge/lib/back.vfx           \ Backward compatibility shim

\ =============================================================================
\ Kickoff
\ =============================================================================
public

: engineer-entrypoint ( hinst hpinst lpcommand nshow -- res )
    init-nib
    over zcount zcommand zplace
    vfxforth-entrypoint ;

: engineer.cold ( - )
    \ Main Engineer entry point - initialize and run with command line args
    init-vfx-console
    (.cold)
    ."  ~~~ Engineer v2 (regress) ~~~ " cr
    frigid 
    freeze  \ TODO: Needed because otherwise we get dictionary corruption if we call EMPTY in engineer.exe
            \       Gotta maybe report this as a bug.
\    init-ide
    \ zcommand zcount strip-exe interpret-string \ ide-interpret
    \ ?dup if .throw else ( go ) then 
    >vfx ;

' engineer-entrypoint is EntryPoint
' engineer.cold is .cold

gild-nib

\ TODO: gild the system classifiers
\ || : gild  gild-nib s" redef marker gildpoint" evaluate ;

\ gild

only forth definitions
freeze 