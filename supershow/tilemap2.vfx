require %idir%/checks.vfx
require %idir%/utilities.vfx
require %idir%/traits.vfx
require %idir%/asset.vfx
require %idir%/bitmap.vfx
require %idir%/tileset.vfx

require %idir%/config.vfx

\ =============================================================================
\ Tilemap rendering
\ =============================================================================

|| 0 value lm

|| : nr ( - ) lm peny@ ygap + at ;

|| : put+ ( bmpid - ) 
    dup $FFFFFFFF = if drop 
    else pile@ + put then
    xgap 0 +at ;

: tiles ( a n - 'a ) 
    penx@ to lm 
    udup for @+ put+ loop drop nr tmw cells + ; 

: drawbg ( a cols rows - )
    {: a cols rows :} begin-batch a rows for cols tiles loop drop end-batch ; 

: lay ( a - )
    tmw tmh drawbg ;

: spot ( col row a - a )
    -rot 0 0 tmw 1 - tmh 1 - 2clamp tmw * + cells + ;

: xy>cr ( x. y. - col row )
    xgap ygap 2/ 2>i ;

: att ( col row - ) 
    xgap ygap 2*  xgap 2 / ygap 2 / 2+  at ;

