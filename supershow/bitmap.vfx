public

65536 ?constant #bitmaps

|| create bitmaps #bitmaps cells allot&erase
|| #bitmaps cell array bitmap-objects

variable next-bmp# 1 next-bmp# !

|| : bitmap[]  $FFFF and cells bitmaps + ;
: >albmp ( n - bmp ) bitmap[] @ ;
: alloc-bmp#  next-bmp# @   1 next-bmp# +! ;
: add-bitmap ( bmp - n ) alloc-bmp# dup >r bitmap[] ! r> ;

class: %bitmap
    %asset derive
    prop id 
    prop albmp

    : does-bitmap ( - ) 
        does> -> id @ ;

class;

: bmpobj  bitmap-objects [] @ ;
: ?nullbmp  dup 0= abort" BITMAP-FILE Bitmap is null!" ;
: ?subbmp  dup al_is_sub_bitmap if al_get_parent_bitmap then ;
: bitmap-file ( n - a n ) ?nullbmp ?subbmp bmpobj -> srcpath$ count ;
   
\ %bitmap :: unload ( - )
\     albmp @ -albmp
\     0 id @ bitmap[] !
\     0 albmp ! ;

: bmpwh ( n - w h )
    >albmp ?dup if dup albmpw swap albmph else 0 0 then ;

: bmpw ( n - w )
    bmpwh drop ;

: bmph ( n - h )
    bmpwh nip ;

: put ( n - ) 
    \ draw a sprite; takes a bitfield $F000IIII
    dup >albmp swap 24 rshift draw-bitmap ;

: cput ( n - ) 
    \ draw sprite with center as the origin
    dup dup bmpwh -2 -2 2/ +at put bmpwh 2 2 2/ +at ;

\ : destroy-bitmaps ( - )
\     ." Destroying bitmaps" cr
\     65536 1 do
\         i bitmap[] dup @ ?dup if al_destroy_bitmap then off
\     loop  1 next-bmp# ! ;

\ : unload-bitmaps ( - )
\     %bitmap unload-instances ;
