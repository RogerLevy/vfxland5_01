\ ------------------------------------------------------------------------------
\ Supershow
\
\ minimal engine with actors, VGA colors, CRT effect,
\ sample playback, and tilemaps.
\ ------------------------------------------------------------------------------

\ =============================================================================
\ Constants and Variables
\ =============================================================================

320 ?constant gamew
240 ?constant gameh
20 ?constant gap  
gamew gap / ?constant tmw
gameh gap / ?constant tmh

\ =============================================================================
\ Dependencies
\ =============================================================================

include %idir%/checks.vfx           \ Validations
include %idir%/tweak.vfx              \ Persistent variable control
include %idir%/../lib/bin.vfx       \ Binary serialization format (deprecated)
include %idir%/../lib/totem.vfx     \ Persistent data system
include %idir%/shader.vfx           \ Shaders 
include %idir%/crt.vfx              \ CRT shader
include %idir%/waveplay.vfx         \ Audio engine
include %idir%/utilities.vfx        \ Math helpers, audio, and misc utilities
include %idir%/traits.vfx           \ Object traits

\ =============================================================================
\ Stage
\ =============================================================================

include %idir%/stage.vfx            \ Actor/sprite system

\ =============================================================================
\ Asset types
\ =============================================================================

include %idir%/bitmap.vfx           \ Bitmaps
include %idir%/tilemap2.vfx         \ Tilemap rendering & Tileset class
include %idir%/scene.vfx            \ Scene management

\ =============================================================================
\ Tilemap
\ =============================================================================

include %idir%/udlr.vfx             \ Movement utilities
include %idir%/tmcol.vfx            \ Tilemap collision detection
include %idir%/tread.vfx            \ Tilemap data reading
include %idir%/sprite.vfx           \ Sprite animation (depends on tilesets)
include %idir%/autoclass.vfx        \ Auto-generate classes from bitmaps

\ =============================================================================
\ Cleanup (not needed)
\ =============================================================================

\ : cleanup-supershow ( - )
\     destroy-bitmaps
\     hush destroy-samples 
\     cleanup-crt ;

\ prune: cleanup-supershow ;
\ ['] cleanup-supershow AtExit 

\ =============================================================================
\ Initialization
\ =============================================================================

: supershow-process-dirchange ( NOTIFY_INFO - )
    cell+ @ case
        FILE_ACTION_ADDED of
            ." FILE_ACTION_ADDED" cr
            %totem -> dependents list-count for
                @next [[
                    changed-file me -> default-dir$ count strin? if
                        changed-file '.' ending me -> extension$ count s= if
                            ." New file discovered!" cr
                            changed-file me manifest o.
                        then
                    then
                ]]
            loop drop
        endof
        FILE_ACTION_MODIFIED of
            ." FILE_ACTION_MODIFIED" cr
            changed-file -path >pad find if
                ." Reloading file!" cr
                >body reload
            else
                drop
            then
        endof
    endcase ;

: init-supershow ( - )
    hold off
    init-bitmaps
    init-tilesets
    init-samples
    init-crt
    debug @ if
        ['] supershow-process-dirchange is process-dirchange
    else
        display al_hide_mouse_cursor
    then 
    show> sprites step ;

init-supershow

: boot-supershow ( - )
    init-supershow 
    c" main" find if execute else drop then ;

' boot-supershow is boot

: load-project ( - )
    create-autoclasses
    ['] load-default-dir script-classes each@
    %scene load-default-dir
    s" modes.vfx" ?included ;

\ Tools
debug @ [if]
    include %idir%/tools.vfx                \ Development tools
    include %idir%/sketchpad/sketchpad.vfx  \ Stage editor
    s" sketchpad" <f12> func
[then]