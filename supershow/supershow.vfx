\ ------------------------------------------------------------------------------
\ Supershow
\
\ minimal engine with actors, VGA colors, CRT effect,
\ sample playback, and tilemaps.
\ ------------------------------------------------------------------------------

\ =============================================================================
\ Validations
\ =============================================================================

include %idir%\checks.vfx

\ =============================================================================
\ Constants and Variables
\ =============================================================================

20 ?constant gap  
320 gap / ?constant tmw
240 gap / ?constant tmh
320 ?constant gamew
240 ?constant gameh

\ =============================================================================
\ Dependencies
\ =============================================================================

include %idir%\bitmap.vfx    \ Bitmaps
include %idir%\shader.vfx    \ Shaders 
include %idir%\crt.vfx       \ CRT shader
include %idir%\waveplay.vfx  \ Audio engine
include %idir%\utilities.vfx \ Math helpers, audio, and misc utilities

\ =============================================================================
\ Stage
\ =============================================================================

include %idir%\traits.vfx    \ Object traits
include %idir%\stage.vfx     \ Actor/sprite system
include %idir%\scene.vfx     \ Scene management
include %idir%\autoclass.vfx \ Auto-generate classes from bitmaps

\ =============================================================================
\ Tilemap
\ =============================================================================

\ include %idir%\tilemap.vfx  \ Tilemap rendering Tileset class
include %idir%\tilemap2.vfx
include %idir%\udlr.vfx     \ Movement utilities
include %idir%\tmcol.vfx    \ Tilemap collision detection
include %idir%\tread.vfx    \ Tilemap data reading
include %idir%\sprite.vfx   \ Sprite animation (depends on tilesets)

\ =============================================================================
\ Initialization
\ =============================================================================

: cleanup-supershow ( - )
    destroy-bitmaps
    hush destroy-samples 
    cleanup-crt ;

prune: cleanup-supershow ;
\ ['] cleanup-supershow AtExit    \ Not needed, OS should take care of this

: supershow-process-dirchange ( NOTIFY_INFO - )
    cell+ @ case
        FILE_ACTION_ADDED of
            ." FILE_ACTION_ADDED" cr
            _totem -> dependents list-count for
                @next [[
                    changed-file me -> default-dir$ count strin? if
                        changed-file '.' ending me -> extension$ count s= if
                            ." New file discovered!" cr
                            changed-file me manifest o.
                        then
                    then
                ]]
            loop drop
        endof
        FILE_ACTION_MODIFIED of
            ." FILE_ACTION_MODIFIED" cr
            changed-file -path >pad find if
                ." Reloading file!" cr
                >body reload
            else
                drop
            then
        endof
    endcase ;

: init-supershow ( - )
    hold off
    init-bitmaps
    init-tilesets
    load-samples
    init-crt
    debug @ if
        ['] supershow-process-dirchange is process-dirchange
    else
        display al_hide_mouse_cursor
    then ;

init-supershow

\ Default engine configuration
' init-supershow is boot
:now show> sprites step ;

\ Tools
debug @ [if]
    include %idir%/tools.vfx                \ Development tools
    include %idir%/sketchpad/sketchpad.vfx  \ Stage editor
    s" sketchpad" <f12> func
[then]
