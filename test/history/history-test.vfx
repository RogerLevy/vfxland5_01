\ ------------------------------------------------------------------------------
\ Test Suite for Dynamic History Component
\ ------------------------------------------------------------------------------

include engineer/vfxcore.vfx
include engineer/history_dynamic.vfx

variable test-count
variable pass-count

: test-init
    0 test-count !
    0 pass-count !
    cr ." Starting History Component Tests..." cr ;

: assert ( flag msg-addr msg-len - )
    1 test-count +!
    rot if
        1 pass-count +!
        ." [PASS] "
    else
        ." [FAIL] "
    then
    type cr ;

: test-basic-init
    cr ." Test 1: Basic Initialization"
    1000 50 init-history
    5 visible-lines !
    
    history-empty? s" History should be empty after init" assert
    line-count @ 0= s" Line count should be 0" assert
    current-history-length 0= s" History length should be 0" assert ;

: test-single-line
    cr ." Test 2: Single Line Addition"
    clear-history
    
    s" Hello World" add-history
    line-count @ 1 = s" Should have 1 line" assert
    history-empty? not s" History should not be empty" assert
    
    0 line-text s" Hello World" s= s" Line text should match" assert ;

: test-multiple-lines
    cr ." Test 3: Multiple Lines"
    clear-history
    
    s" Line 1" add-history
    s" Line 2" add-history  
    s" Line 3" add-history
    
    line-count @ 3 = s" Should have 3 lines" assert
    0 line-text s" Line 1" s= s" First line correct" assert
    1 line-text s" Line 2" s= s" Second line correct" assert
    2 line-text s" Line 3" s= s" Third line correct" assert ;

: test-embedded-crs
    cr ." Test 4: Embedded CR Characters"
    clear-history
    
    \ Create string with embedded CR
    here dup ." Multi" 13 over 5 + c! ." line" 9 swap
    add-history
    
    line-count @ 2 = s" Should split into 2 lines at CR" assert ;

: test-scrolling
    cr ." Test 5: Scrolling Operations"
    clear-history
    3 visible-lines !
    
    s" Line 1" add-history
    s" Line 2" add-history
    s" Line 3" add-history
    s" Line 4" add-history
    s" Line 5" add-history
    
    scroll-pos @ 2 = s" Should auto-scroll to show last 3 lines" assert
    
    scroll-up
    scroll-pos @ 1 = s" Scroll up should work" assert
    
    scroll-to-top
    scroll-pos @ 0= s" Scroll to top should work" assert
    
    scroll-to-bottom
    scroll-pos @ 2 = s" Scroll to bottom should work" assert ;

: test-resize
    cr ." Test 6: Buffer Resizing"
    100 10 init-history  \ small buffer
    
    \ Add enough content to force resize
    s" This is a long line that should help fill up the buffer" add-history
    s" Another long line to fill more space in the buffer" add-history
    s" Yet another line to ensure we exceed initial size" add-history
    
    history-size @ 100 > s" Buffer should have been resized" assert
    line-count @ 3 = s" All lines should still be present" assert ;

: test-edge-cases
    cr ." Test 7: Edge Cases"
    clear-history
    
    \ Empty string
    s" " add-history
    line-count @ 0= s" Empty string should be ignored" assert
    
    \ String that already ends with CR
    here dup s" HasCR" swap place 13 over 5 + c! 6 swap
    add-history
    line-count @ 1 = s" String with CR should work" assert ;

: run-all-tests
    test-init
    
    test-basic-init
    test-single-line
    test-multiple-lines
    test-embedded-crs
    test-scrolling
    test-resize
    test-edge-cases
    
    cr cr ." Test Results: " 
    pass-count @ . ." out of " test-count @ . ." tests passed"
    pass-count @ test-count @ = if
        cr ." All tests PASSED!" cr
    else
        cr ." Some tests FAILED!" cr
    then
    
    free-history ;

: demo-history
    cr ." History Component Demo:" cr
    
    1000 20 init-history
    5 visible-lines !
    
    s" Welcome to the history demo" add-history
    s" This is line 2" add-history
    s" Here's line 3" add-history
    s" Line 4 content" add-history
    s" Line 5 is here" add-history
    s" Line 6 for testing" add-history
    s" Final line 7" add-history
    
    cr ." Current view (should show last 5 lines):"
    render-history
    
    cr ." Scrolling to top:"
    scroll-to-top
    render-history
    
    cr ." History stats:"
    history-stats
    
    free-history ;

\ Uncomment to run tests automatically:
\ run-all-tests
\ demo-history